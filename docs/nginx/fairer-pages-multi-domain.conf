# Fairer Pages â€” Multi-domain nginx configuration
# Uses an nginx map to assign different playlists per domain.
# Replace the hostnames, upstream address, and playlist names with your own.

upstream fairer-pages {
    server fairer-pages-host:8023;
}

map $host $fairer_playlist {
    default                 "random";
    "work.example.com"      "playlist/work";
    "fun.example.com"       "playlist/meme";
    "zen.example.com"       "playlist/nature";
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name work.example.com fun.example.com zen.example.com;

    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;

    location / {
        proxy_pass http://some-important-service:port/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    proxy_intercept_errors on;
    error_page 400 401 402 403 404 405 406 408 409 410 413 429 500 502 503 504 = @error_handler;

    location /fairer-pages/ {
        proxy_pass http://fairer-pages/fairer-pages/;
        add_header Content-Security-Policy "frame-ancestors 'self';";
        proxy_set_header Host $host;
    }

    # Playlist is selected per-domain via the $fairer_playlist map above
    location @error_handler {
        proxy_pass http://fairer-pages/fairer-pages/$fairer_playlist/$status.html;
        proxy_set_header Host $host;
        internal;
    }
}
